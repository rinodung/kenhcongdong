/*
 * Screets Chat
 * Application scripts
 *
 * Copyright (c) 2013 Screets
 */
(function(a){a(document).ready(function(){b.init();a(window).unload(function(){sc_chat.is_admin&&a.ajax({type:"POST",url:sc_chat.ajaxurl+"?mode=logout",data:"action=sc_chat_ajax_callback",async:!1})})});var b={data:{first_time:!0,last_log_ID:0,no_activity:0,logged_in:!1,sender:"",win_is_active:0,sc_chat_box_visible:!1,error:!1},init:function(){var d=!1;window.onfocus=function(){b.data.win_is_active=1};window.onblur=function(){b.data.win_is_active=0};!0==sc_chat.is_admin&&(a.sc_POST("login","action=sc_chat_ajax_callback&f_chat_user_name="+
sc_chat.username+"&f_chat_user_email="+sc_chat.email+"&f_chat_is_admin=true",function(a){d=!1;a.error?b.display_error(a.error):b.login(a.name,a.gravatar,!0)}),a(document).on("click",".sc-chat-users .user",function(){var c=a(this).attr("data-receiver-id"),d=a(this).attr("data-visitor-id");b.open_new_tab(c,d,!0);return!1}),a("ul.sc-chat-tabs").each(function(){var c,b=a(this).find("li");b.addClass("active");b.not(c).each(function(){a(a(this).attr("href")).hide()});a(document).on("click",".sc-chat-tab-content",
function(){a("ul.sc-chat-tabs li.active").removeClass("new-msg")});a(this).on("click","li a",function(d){a("ul.sc-chat-tabs li").removeClass("active new-msg");a(".sc-chat-tab-content").removeClass("active");c=a(this).parent();b=a(a(this).attr("href"));c.addClass("active");b.addClass("active");a(".sc-cnv-wrap").scrollTop(1E4);b.find(".f-chat-line").focus();d.preventDefault()});a(this).on("click","li .close",function(c){var b=a(this).prev().attr("data-receiver-id");a("ul.sc-chat-tabs li").removeClass("active new-msg");
a(".sc-chat-tab-content").removeClass("active");a(".console-tab").addClass("active");a("#Console").addClass("active");a("#Tab_"+b).remove();a("#Receiver_"+b).remove();c.preventDefault()})}),a(".sc-chat-login-btn").click(function(){var c=a(this);b.data.current_status=a(this).attr("data-status");"online"==b.data.current_status?a.sc_POST("offline","action=sc_chat_ajax_callback",function(){a('.user[data-user-type="1"]').fadeOut(1E3);b.get_online_users();c.attr("data-status","offline").html('<i class="sc-icon-offline"></i> '+
sc_chat.tr_offline);b.data.current_status="offline";a("#Chat_console").removeClass("sc-online").addClass("sc-offline");b.play_sound("offline")}):"offline"==b.data.current_status&&a.sc_POST("online","action=sc_chat_ajax_callback",function(){b.get_online_users();a('.user[data-user-type="ME"]').show();c.attr("data-status","online").html('<i class="sc-icon-online"></i> '+sc_chat.tr_online);b.data.current_status="online";a("#Chat_console").removeClass("sc-offline").addClass("sc-online");b.play_sound("online")})}),
a(document).on("click",".sc-chat-refresh",function(){receiver_ID=a(this).parent().parent().parent().parent().attr("data-receiver-id");visitor_ID=a("#User_"+receiver_ID).attr("data-visitor-id");b.get_user_info(visitor_ID,receiver_ID)}));sc_chat.is_admin||(a("#SC_send_form_btn").click(function(){a("#SC_contact_form").submit()}),a("#SC_contact_form").submit(function(){a(".sc-chat-notification").fadeIn(100).removeClass("error success").html(sc_chat.tr_sending+"...");a.sc_POST("send_contact_from",a(this).serialize(),
function(c){c.error?a(".sc-chat-notification").addClass("error").html(c.error):(a(".sc-chat-notification").addClass("success").html(c.message).delay(1500).fadeOut(500),a(".sc-chat-header-title").html(c.message).delay(4E3).queue(function(c){a(this).html(sc_chat.tr_offline_header);c()}),a('#SC_contact_form input[type="text"], #SC_contact_form textarea').val(""),setTimeout(b.hide_chatbox,2700))});return!1}),a("#SC_start_chat_btn").click(function(){a("#SC_login_form").submit()}),a("#SC_login_form input").keydown(function(c){13==
c.keyCode&&a("#SC_login_form").submit()}),a("#SC_login_form").submit(function(){if(d)return!1;d=!0;a.sc_POST("login",a(this).serialize(),function(a){d=!1;a.error?b.display_error(a.error):b.login(a.name,a.gravatar,!0)});return!1}),1==sc_chat.use_css_anim?setTimeout(b.animate_chatbox,500*sc_chat.delay):setTimeout(b.animate_chatbox,1E3*sc_chat.delay));a(document).on("keydown",".f-chat-line",function(c){13==c.keyCode&&!c.shiftKey&&(c.preventDefault(),a(this).parent().submit(),a(this).val(""),a(this).trigger("autosize"))});
a(document).on("submit","#Reply_form",function(){var c=a(this).find(".f-receiver-id").val(),e=a.trim(a(this).find(".f-chat-line").val()),f=a(this).serialize(),j=a(".f-chat-line");if(0==e.length||d)return!1;d=!0;var h="t"+Math.round(1E6*Math.random()),g={ID:h,author:b.data.name,gravatar:b.data.gravatar,receiver_ID:c,chat_line:e.replace(/</g,"&lt;").replace(/>/g,"&gt;")};j.addClass("sc-chat-sending");b.add_chat_line(a.extend({},g));a.sc_POST("send_chat_msg",f,function(c){d=!1;a(".f-chat-line").val("").removeClass("sc-chat-sending");
a("div.chat-"+h).remove();c.error?(b.display_error(c.error),a("#Reply_form .f-chat-line").attr("disabled","disabled").addClass("sc-chat-error")):(g.ID=c.insert_ID,b.add_chat_line(a.extend({},g)))});return!1});a(document).on("click",".sc-chat-btn-logout",function(){b.data.logged_in=!1;a.sc_POST("logout","action=sc_chat_ajax_callback",function(){!0==sc_chat.is_admin?window.location.href="./":a("#Conversation").fadeOut(300,function(){a(".sc-chat-wrapper").fadeIn(300,function(){setTimeout(function(){b.hide_chatbox()},
1E3)})})});return!1});a.sc_GET("is_user_logged_in","action=sc_chat_ajax_callback",function(a){var d=!0;!sc_chat.is_admin&&!0==sc_chat.is_op&&(d=!1);a.logged&&d&&b.login(a.user.name,a.user.email,!1)});(function e(){b.get_online_users(e)})();(function f(){b.get_chat_lines(f)})()},login:function(d,c,e){b.data.name=d;b.data.gravatar=c;b.data.logged_in=!0;!0==sc_chat.is_admin?(a(".sc-chat-login-btn").attr("data-status","online").html('<i class="sc-icon-online"></i> '+sc_chat.tr_online),a("#Chat_console").addClass("sc-online")):
(b.open_chatbox(),!0==e?a(".sc-chat-wrapper").fadeOut(function(){a(".sc-chat-notification").html("").hide();a("#Conversation").fadeIn();a(".f-chat-line").focus().autosize();a(".sc-cnv-wrap").scrollTop(1E4)}):(a(".sc-chat-wrapper").hide(),"on"==a.cookie("sc_chat_chatbox_status")&&(delay=1==sc_chat.use_css_anim?500*sc_chat.delay:1E3*sc_chat.delay,setTimeout(function(){a("#Conversation").show();a(".f-chat-line").autosize();a(".sc-cnv-wrap").scrollTop(1E4)},delay),b.data.sc_chat_box_visible=!0)));b.data.first_time=
!1},render:function(a,c){var b=[];switch(a){case "login_top_bar":b=['<span><img src="',c.gravatar,'" width="23" height="23" />','<span class="name">',c.name,'</span><a href="" class="logoutButton rounded">',c.tr_logout,"</a></span>"];break;case "chat_line":b=['<div class="sc-msg-wrap chat chat-',c.ID,'" data-user-id="',c.author,'"><div class="sc-chat-time">',c.time,'</div><div class="sc-usr-avatar"><img src="',c.gravatar,'" width="38" height="38" onload="this.style.visibility=\'visible\'" />','</div><div class="sc-msg"><div class="sc-usr-name">',
c.author,':</div><div class="sc-chat-line">',c.chat_line,'</div></div><div class="clearfix"></div></div>'];break;case "user":b=['<a id="User_',c.name,'" href="#Receiver_',c.ID,'" class="user" data-receiver-id="',c.name,'" data-visitor-id="',1==c.type?c.ID:c.visitor_ID,'" data-user-type="',c.type,'"><img class="avatar" src="',c.gravatar,'" onload="this.style.visibility=\'visible\'" /> <div class="username"> <strong>',c.name,"</strong> (",c.email,")<small>",c.tagline,"</small></div></a>"];break;case "new_tab_title":b=
['<li class="',c.custom_class,'" id="Tab_',c.ID,'"><a href="#Receiver_',c.ID,'" data-receiver-id="',c.ID,'">',c.ID,'</a> <button type="button" class="close">&times;</button></li>'];break;case "new_tab_content":b=['<div id="Receiver_',c.ID,'" data-receiver-id="',c.ID,'" class="',c.custom_class,' sc-chat-tab-content"><div class="sc-chat-inner"><div id="SC_cnv_wrap" class="sc-cnv-wrap"><div class="sc-chat-user-agent">',c.user_info?c.user_info:'<a href="javascript:void(0)" class="sc-chat-refresh">Refresh</a>',
'</div></div><div class="sc-chat-tip"></div></div><form id="Reply_form" method="post" action="" class="sc-chat-reply"><input type="hidden" name="action" value="sc_chat_ajax_callback" /><input type="hidden" name="receiver_ID" class="f-receiver-id" value="',c.ID,'" /><input type="hidden" name="visitor_ID" class="f-visitor-id" value="',c.visitor_ID,'" /><textarea name="chat_line" class="f-chat-line" maxlength="700" placeholder="',sc_chat.tr_write_a_reply,'"></textarea></form></div>']}return b.join("")},
open_new_tab:function(d,c,e){user_type=a('.sc-chat-users a[data-visitor-id="'+c+'"]').attr("data-user-type");var f=[];f.ID=d;f.visitor_ID=c;f.custom_class="";f.user_info="1"==user_type||!c?"":sc_chat.tr_loading+"...";if(0==a(".sc-chat-tabs li#Tab_"+d).length){if(1==a(".sc-chat-tabs .console-tab.active").length||e)a(".sc-chat-tabs li").removeClass("active"),a(".sc-chat-tab-content").removeClass("active"),f.custom_class="active ";a(".sc-chat-tabs").append(b.render("new_tab_title",f));a(".sc-chat-tab-contents").append(b.render("new_tab_content",
f));a("#Receiver_"+d+" .f-chat-line").focus()}b.get_user_info(c,d);return!1},get_user_info:function(d,c){b.data.receiver_ID=c;a.sc_GET("user_info","action=sc_chat_ajax_callback&ID="+d,function(a){"null"!=a.device_name&&(b.data.user_info=a.device_name+" "+a.device_version+" - "+a.platform+", "+a.ip_address+' &nbsp; <a href="admin.php?page=sc_chat_m_chat_logs&action=edit&visitor_ID='+d+'" target="_blank">'+sc_chat.tr_chat_logs+"</a>",b.update_user_info())})},update_user_info:function(){a("#Receiver_"+
b.data.receiver_ID+" .sc-chat-user-agent").html(b.data.user_info)},add_chat_line:function(d){if(!0==sc_chat.is_admin){d.author==sc_chat.username&&d.receiver_ID==sc_chat.username?b.data.sender=sc_chat.username:d.receiver_ID==sc_chat.username?b.data.sender=d.author:d.author==sc_chat.username?b.data.sender=d.receiver_ID:"__OP__"==d.receiver_ID&&(b.data.sender=d.author);if(b.data.sender){var c=a("#User_"+b.data.sender).attr("data-visitor-id");b.open_new_tab(b.data.sender,c);b.update_user_info()}a("#Tab_"+
d.author+":not(.active)").addClass("new-msg")}c=new Date;d.time&&c.setUTCHours(d.time.hours,d.time.minutes);d.time=(10>c.getHours()?"0":"")+c.getHours()+":"+(10>c.getMinutes()?"0":"")+c.getMinutes();c=b.render("chat_line",d);exists=a(".sc-cnv-wrap .chat-"+d.ID);exists.length&&exists.remove();b.data.last_log_ID||a(".sc-cnv-wrap .sc-lead").remove();var e=!0==sc_chat.is_admin?a("#Receiver_"+b.data.sender+" .sc-cnv-wrap"):a(".sc-cnv-wrap");if("t"!=d.ID.toString().charAt(0)){var f=e.find(".chat-"+(+d.ID-
1));f.length?f.after(c):e.append(c)}else e.append(c);a(".sc-cnv-wrap").scrollTop(1E5);b.data.last_user=d.author},get_chat_lines:function(d){!b.data.logged_in&&!1==sc_chat.is_admin?setTimeout(d,1E3):a.sc_GET("get_chat_lines",{last_log_ID:b.data.last_log_ID,action:"sc_chat_ajax_callback",sender:b.data.sender},function(a){for(var e=0;e<a.chats.length;e++)b.add_chat_line(a.chats[e]);a.chats.length?(b.data.no_activity=0,b.data.last_log_ID=a.chats[e-1].ID,!0!=b.data.first_time&&(0==b.data.win_is_active||
!0==sc_chat.is_admin)&&b.play_sound("new_message")):b.data.no_activity++;a=1E3;3<b.data.no_activity&&(a=2E3);10<b.data.no_activity&&(a=5E3);20<b.data.no_activity&&(a=15E3);setTimeout(d,a)})},get_online_users:function(d){!b.data.logged_in&&!1==sc_chat.is_admin?setTimeout(d,3E3):a.sc_GET("get_online_users",{action:"sc_chat_ajax_callback"},function(c){if(!0==sc_chat.is_admin){for(var e=[],f=0;f<c.users.length;f++)c.users[f]&&e.push(b.render("user",c.users[f]));f="";f=1>c.total?sc_chat.tr_no_one_online:
1==c.total?sc_chat.tr_1_person_online:sc_chat.tr_x_people_online.replace("%s",c.total);e.push('<p class="count">'+f+"</p>");a("#People_list .sc-chat-users").html(e.join(""))}setTimeout(d,15E3)})},animate_chatbox:function(){var d=a("#sc_chat_box"),c=a("#sc_chat_box .sc-chat-header"),e=d.innerHeight(),f=c.innerHeight();d.css("bottom","-"+e+"px");d.css("visibility","visible");1==sc_chat.use_css_anim?(d.css("bottom","-"+(e-f)+"px").addClass("sc-chat-animated sc-chat-bounce-in-up"),c.click(function(){a.removeCookie("sc_chat_chatbox_status");
e=d.innerHeight();f=c.innerHeight();!1==b.data.sc_chat_box_visible?(e=d.innerHeight(),f=c.innerHeight(),d.css("bottom",0).addClass("sc-chat-css-anim"),setTimeout(function(){480<window.innerWidth&&(a("#f_chat_user_name").length?a("#f_chat_user_name, .f-chat-line").focus():a("#f_chat_user_email, .f-chat-line").focus())},500),!0==b.data.logged_in&&(a("#Conversation").show(),setTimeout(function(){a(".f-chat-line").focus().autosize()},500)),a.cookie("sc_chat_chatbox_status","on",{expires:1}),b.data.sc_chat_box_visible=
!0):(d.css("bottom","-"+(e-f)+"px"),a.cookie("sc_chat_chatbox_status","off",{expires:1}),b.data.sc_chat_box_visible=!1)})):(d.stop().animate({bottom:"+="+f},{duration:900,easing:"easeOutBack"}),c.click(function(){a("#Conversation").show();a.removeCookie("sc_chat_chatbox_status");e=d.innerHeight();f=c.innerHeight();!1==b.data.sc_chat_box_visible?(d.stop().animate({bottom:0},{duration:200,easing:"easeOutExpo",complete:function(){480<window.innerWidth&&(a("#f_chat_user_name").length?a("#f_chat_user_name, .f-chat-line").focus():
a("#f_chat_user_email, .f-chat-line").focus())}}),a.cookie("sc_chat_chatbox_status","on",{expires:1}),b.data.sc_chat_box_visible=!0):(a.cookie("sc_chat_chatbox_status","off",{expires:1}),d.stop().animate({bottom:"-"+(e-f)},{duration:190,easing:"easeOutExpo"}),a.cookie("sc_chat_chatbox_status","off",{expires:1}),b.data.sc_chat_box_visible=!1)}))},open_chatbox:function(){var b=a("#sc_chat_box");a("#Reply_form .f-chat-line").removeAttr("disabled").removeClass("sc-chat-error");1==sc_chat.use_css_anim?
b.css("bottom",0):(b.stop().animate({bottom:0},{duration:200,easing:"easeOutExpo"}),a("#f_chat_user_name, .f-chat-line").focus())},hide_chatbox:function(){var d=a("#sc_chat_box"),c=a("#sc_chat_box .sc-chat-header");sc_chat_box_h=d.innerHeight();sc_chat_header_h=c.innerHeight();1==sc_chat.use_css_anim?d.css("bottom","-"+(sc_chat_box_h-sc_chat_header_h)+"px"):d.stop().animate({bottom:"-"+(sc_chat_box_h-sc_chat_header_h)},{duration:190,easing:"easeOutExpo"});b.data.sc_chat_box_visible=!1},add_source:function(b,
c){a("<source>").attr("src",c).appendTo(b)},play_sound:function(d){if("none"!=sc_chat.sound_package){var c=a("<audio />",{autoPlay:"autoplay"});b.add_source(c,sc_chat.plugin_url+"/assets/sounds/"+d+".mp3");b.add_source(c,sc_chat.plugin_url+"/assets/sounds/"+d+".ogg");b.add_source(c,sc_chat.plugin_url+"/assets/sounds/"+d+".wav");c.appendTo("body")}},display_error:function(b){var c=!0==sc_chat.is_admin?"error":"";a(".sc-chat-notification").show().html("").delay(500).html('<div class="'+c+'">'+b+"</div>")},
hide_error:function(){a(".sc-chat-notification").hide()}};a.sc_POST=function(d,c,e){a.post(sc_chat.ajaxurl+"?mode="+d,c,e,"json").fail(function(a){b.data.error=!0;console.log(a);b.display_error(sc_chat.tr_general_error);return!1}).done(function(){!0==b.data.error&&b.hide_error();b.data.error=!1})};a.sc_GET=function(d,c,e){a.get(sc_chat.ajaxurl+"?mode="+d,c,e,"json").fail(function(a){b.data.error=!0;console.log(a);b.display_error(sc_chat.tr_general_error);return!1}).done(function(){!0==b.data.error&&
b.hide_error();b.data.error=!1})}})(window.jQuery||window.Zepto);